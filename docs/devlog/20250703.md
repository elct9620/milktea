# Development Log - 2025-07-03

## What's New

#### Renderer Abstraction for Clean Separation of Concerns

The Milktea framework now features a dedicated `Renderer` class that handles all terminal user interface rendering operations. This new abstraction brings several benefits to TUI developers:

- **Screen Management**: Automatic screen clearing and cursor positioning using the `tty-cursor` gem ensures clean rendering without visual artifacts
- **Output Flexibility**: Support for custom output streams allows easy testing with `StringIO` and potential future support for different output formats
- **Lifecycle Methods**: Clear `setup_screen()` and `restore_screen()` methods handle terminal state management, ensuring proper cleanup when programs exit
- **Clean API**: Simple `render(model)` method that takes care of all rendering complexities internally

This separation allows developers to focus on their application logic while the renderer handles the intricacies of terminal manipulation.

#### Full Keyboard Event Handling

Interactive TUI applications now have access to comprehensive keyboard input through integration with `TTY::Reader`. The new `KeyPress` message type provides rich event data:

- **Complete Key Information**: Access to both raw key values and character representations
- **Modifier Key Support**: Built-in tracking of Ctrl, Alt, and Shift states enables complex keyboard shortcuts
- **Non-blocking Input**: Keyboard events are read without blocking the main event loop, maintaining responsive applications
- **Graceful Interrupt Handling**: Ctrl+C is properly handled through TTY::Reader's error mode, preventing abrupt terminations

This enhancement empowers developers to create sophisticated keyboard-driven interfaces with minimal effort.

#### Counter Example Application

A new example demonstrates best practices for building Milktea applications. The counter showcases:

- **State Management**: Proper use of immutable state updates through the `Model#with` method
- **User Interaction**: Intuitive keyboard controls (+/k for increment, -/j for decrement, r for reset, q for quit)
- **Clean UI**: Clear instructions and visual feedback demonstrate effective TUI design
- **Architecture Patterns**: Real-world application of the Elm Architecture within the Ruby ecosystem

This example serves as both a learning resource and a template for new TUI applications.

## What's Fixed

#### Screen Clearing and Rendering Artifacts

**Problem**: Previous renders would leave visual artifacts on screen, creating a messy user experience as old content remained visible beneath new renders.

**Solution**: The new Renderer class now properly clears the entire screen and resets the cursor to position (0,0) before each render cycle. This ensures each frame starts with a clean slate, eliminating any overlap or ghosting effects from previous renders.

**Impact**: TUI applications now provide a clean, professional appearance with smooth visual updates that don't leave traces of previous states.

#### Hardcoded Exit Key Limitations

**Problem**: The framework previously hardcoded certain keys for exiting applications, limiting developer control over keyboard interactions and preventing custom exit strategies.

**Solution**: Removed all hardcoded exit keys from the Program class. Models now have complete control over keyboard event handling, including when and how to terminate the application.

**Impact**: Developers can now implement custom exit confirmations, save prompts, or completely different key bindings for application termination, providing full control over the user experience.

## Design Decisions

#### Renderer as a Separate Component

**Context**: The Program class was becoming complex, handling both event loop management and rendering responsibilities. This violated the single responsibility principle and made testing difficult.

**Choice**: Extract all rendering logic into a dedicated Renderer class that can be injected into the Program.

**Rationale**: This separation provides multiple benefits:
- Easier unit testing through dependency injection
- Potential for alternative renderer implementations (e.g., web-based output)
- Cleaner Program class focused solely on event loop management
- Better adherence to SOLID principles

This decision aligns with the framework's clean architecture approach and makes the codebase more maintainable and extensible.

#### Enhanced Testing Philosophy

**Context**: The existing RSpec tests were using various patterns, some of which tested implementation details rather than behavior.

**Choice**: Established comprehensive testing guidelines emphasizing behavioral testing over implementation testing.

**Rationale**: The new guidelines promote:
- Using spy patterns for cleaner delegation tests
- Avoiding private instance variable testing
- Leveraging RSpec's built-in matchers like `output`
- Focusing on public API behavior

These practices lead to more maintainable tests that don't break with internal refactoring, while still ensuring correctness.

#### Non-blocking Keyboard Input

**Context**: TUI applications need to remain responsive while waiting for user input, but blocking I/O operations can freeze the interface.

**Choice**: Implement keyboard reading using TTY::Reader's non-blocking `read_keypress` method within the main event loop.

**Rationale**: This approach ensures:
- The event loop continues processing messages and timers while waiting for input
- Applications can implement animations or real-time updates
- Better user experience with responsive interfaces
- Alignment with modern event-driven programming patterns

## Impact

These changes significantly enhance the Milktea framework's usability and architecture. Ruby developers building TUI applications now have:

- **Better Separation of Concerns**: Clear boundaries between rendering, input handling, and application logic
- **More Control**: Full ownership of keyboard handling and application behavior
- **Improved Testing**: Cleaner patterns for writing maintainable test suites
- **Professional Output**: Artifact-free rendering for polished user interfaces
- **Learning Resources**: Practical examples demonstrating framework best practices

The framework now provides a more solid foundation for building sophisticated terminal applications while maintaining the simplicity and elegance of the Elm Architecture.

## Files Modified

- `lib/milktea/renderer.rb` - New Renderer class for TUI rendering
- `lib/milktea/program.rb` - Refactored to use Renderer and handle keyboard events
- `lib/milktea/message.rb` - Added KeyPress message type
- `examples/counter.rb` - New counter example application
- `examples/simple.rb` - Updated with keyboard interaction
- `spec/milktea/renderer_spec.rb` - Tests for new Renderer class
- `spec/milktea/program_spec.rb` - Updated tests for refactored Program
- `CLAUDE.md` - Enhanced RSpec testing guidelines