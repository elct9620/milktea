# Development Log - 2025-07-04

## What's New

#### Optional Loader System for Flexible Development Patterns
The framework now provides an optional Loader system that enables developers to choose when autoloading and hot reloading capabilities are needed. This addresses the fundamental difference between standalone examples and full application development workflows.

Key capabilities include:
- **Selective activation**: Examples can run without unnecessary autoloading overhead
- **Explicit configuration**: Applications can enable loading with `config.loader = Milktea::Loader.new(app_dir, runtime)`
- **Graceful degradation**: Hot reloading works when Listen gem is available, falls back to basic autoloading when not
- **Development-focused**: Optimized for the common pattern where examples are lightweight and apps need full development features

#### Enhanced Hot Reloading Architecture
The hot reloading system now provides more granular control over development workflows:

- **Dual-mode operation**: Basic autoloading (always available) and file watching (conditionally enabled)
- **Optional Listen integration**: Detects Listen gem availability at runtime using `gem "listen"` with proper error handling
- **Message-driven reload**: Uses `Message::Reload` for clean communication between Loader and Runtime
- **Zeitwerk integration**: Leverages Zeitwerk's robust autoloading capabilities as the foundation

## What's Fixed

#### Method Naming Consistency
Renamed `hot_reload!` to `hot_reload` to better reflect the method's non-throwing behavior. The method gracefully handles cases where the Listen gem is unavailable, making the exclamation mark suffix misleading. This change improves API consistency and developer expectations.

#### Configuration System Clarity
Resolved the automatic initialization of the loader in the Config class, which was creating unnecessary overhead for simple use cases. The loader is now explicitly `nil` by default, requiring conscious activation for development scenarios that need it.

#### Test Suite Alignment
Updated all test files to follow the project's strict RSpec guidelines from CLAUDE.md:
- Transformed multi-line tests into context + one-liner patterns
- Applied spy pattern instead of `expect().to receive()` for better test isolation
- Maintained comprehensive coverage while improving readability and maintainability

## Design Decisions

#### Reloader â†’ Loader Rename and Optional Architecture
**Context**: The original Reloader was automatically initialized for all applications, creating overhead for simple examples and unclear boundaries between autoloading and hot reloading.

**Decision**: Renamed to Loader and made it optional by default, requiring explicit configuration.

**Rationale**: This design better aligns with the framework's dual usage patterns:
- Examples focus on demonstrating TUI concepts without development overhead
- Applications explicitly enable development features when needed
- Clear separation of concerns between framework core and development tooling

This decision supports the Clean Architecture principle of dependency inversion, where the framework core doesn't depend on development-specific features.

#### Runtime Detection of Optional Dependencies
**Context**: The Listen gem provides file watching capabilities but shouldn't be a hard dependency for the framework.

**Decision**: Use `gem "listen"` with `Gem::LoadError` rescue for runtime detection rather than gemspec dependencies.

**Rationale**: This approach provides:
- Zero additional dependencies for basic usage
- Graceful enhancement when Listen is available
- Clear error boundaries that don't affect core functionality
- Better compatibility with different deployment environments

#### Dependency Injection for Loader
**Context**: The Loader needs access to Runtime for message communication and app_dir for file watching.

**Decision**: Use constructor injection rather than setter injection or service location.

**Rationale**: Constructor injection makes dependencies explicit and ensures the Loader is properly configured at creation time. This aligns with the framework's overall dependency injection pattern and makes testing more straightforward.

## Impact

The optional Loader system significantly improves the developer experience by:

**For Example Development**: Examples now run with minimal overhead, focusing attention on TUI concepts rather than development tooling. This makes the framework more accessible to newcomers and reduces cognitive load when exploring features.

**For Application Development**: Developers get explicit control over when and how autoloading capabilities are enabled, leading to more predictable development workflows and better understanding of their application's loading behavior.

**For Framework Architecture**: The changes reinforce the Clean Architecture patterns by separating core framework functionality from development-specific features. This makes the codebase more maintainable and easier to extend.

**For Testing Strategy**: The refactoring demonstrates and reinforces the project's commitment to RSpec best practices, creating a stronger foundation for future test development and maintaining high code quality standards.

## Files Modified

- `lib/milktea/loader.rb` - Renamed from reloader.rb, implements optional loading system
- `lib/milktea/config.rb` - Made loader optional with attr_accessor instead of automatic initialization
- `lib/milktea/program.rb` - Updated to handle optional loader with early return pattern
- `lib/milktea/message.rb` - Added Message::Reload for hot reload communication
- `lib/milktea/runtime.rb` - Added Message::Reload handling in execute_side_effect
- `spec/milktea/loader_spec.rb` - Renamed from reloader_spec.rb, updated all tests to follow RSpec guidelines
- `spec/milktea/config_spec.rb` - Updated to expect nil loader by default and test optional behavior
- `spec/milktea/program_spec.rb` - Updated delegation tests to reflect removed loader delegation
- `CLAUDE.md` - Updated with comprehensive RSpec style guidelines and development commands