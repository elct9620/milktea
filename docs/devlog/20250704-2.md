# Development Log - 2025-07-04 (Session 2)

## What's New

#### Working Hot Reloading System with Production-Ready Example
Successfully implemented a fully functional hot reloading system for Milktea applications, complete with a comprehensive demonstration example. The system enables developers to modify TUI components in real-time while applications are running, dramatically improving development velocity and iteration speed.

Key features include:
- **Live code reloading**: Edit model files and see changes immediately without restarting
- **Automatic class refresh**: Uses `Kernel.const_get` to ensure fresh class definitions are loaded
- **Graceful degradation**: Works with or without the Listen gem for file watching
- **Interactive demo**: Complete example showing parent-child model reloading with clear instructions

#### Independent Loader Architecture
Redesigned the Loader system to be completely self-contained, eliminating problematic circular dependencies that were preventing proper Model loading. The new architecture separates concerns cleanly and provides a simpler API for developers.

The Loader now:
- Takes a config object and extracts what it needs internally
- Automatically handles hot reloading based on configuration
- Operates independently from the core framework components
- Provides a single `start` method that handles all initialization

#### Comprehensive Hot Reloading Documentation
Added extensive documentation to CLAUDE.md covering all critical aspects of hot reloading setup and troubleshooting. This includes configuration requirements, implementation gotchas, and step-by-step testing procedures that will be essential for future development.

## What's Fixed

#### Circular Dependency Resolution
Resolved critical circular dependencies in the original Loader design where Config needed Runtime to create Loader, but Loader needed Config's runtime and app_path. This was causing Model loading failures and tight coupling between components.

**Root cause**: The original design tried to inject dependencies through Config, creating a circular reference loop.

**Solution**: Made Loader completely independent by having it extract needed values from a passed config object, eliminating the circular dependency chain.

#### Hot Reloading Class Reference Issues
Fixed fundamental issue where hot reloading wasn't working because `self.class.new` was returning cached/stale class objects instead of freshly reloaded classes.

**Root cause**: Ruby's `self.class` returns the class object that was loaded when the instance was created, not the current definition.

**Solution**: Replaced `self.class.new` with `Kernel.const_get(self.class.name).new` in the Model#with method to ensure fresh class definitions are used.

#### Zeitwerk Configuration for Examples
Corrected app_dir configuration for examples directory to work with Zeitwerk's autoloading requirements. Examples lack Gemfile and other project structure, requiring special path handling.

**Impact**: Hot reloading now works correctly for standalone examples, demonstrating the system's flexibility across different project structures.

#### Message::Reload Event Handling
Implemented proper reload event handling in models using the `with` method to rebuild instances with fresh class definitions. This ensures the entire model tree is updated when code changes are detected.

## Design Decisions

#### Loader Independence from Framework Core
**Context**: The original design embedded Loader configuration within the Config class, creating tight coupling and circular dependencies.

**Decision**: Make Loader a completely independent utility that takes a config object and operates autonomously.

**Rationale**: This design provides several key benefits:
- Eliminates circular dependencies that were causing loading failures
- Separates development tooling from core framework functionality
- Simplifies the API for users (single `loader.start()` call)
- Allows Program to focus solely on TUI concerns
- Makes testing easier with clear dependency boundaries

This decision reinforces the Clean Architecture principle of dependency inversion, where high-level modules (core framework) don't depend on low-level modules (development tools).

#### Kernel.const_get for Dynamic Class Loading
**Context**: Hot reloading requires getting fresh class definitions after code changes, but `self.class` returns cached objects.

**Decision**: Use `Kernel.const_get(self.class.name).new(merged_state)` instead of `self.class.new(merged_state)` in Model#with.

**Rationale**: This approach ensures that:
- Fresh class definitions are used after Zeitwerk reloads classes
- The hot reloading system works reliably across all model types
- No additional complexity is introduced to the Model API
- The change is backward compatible and doesn't affect normal operation

The trade-off is slightly more dynamic code, but this is isolated to the development scenario and provides essential functionality.

#### App Directory Configuration Strategy
**Context**: Zeitwerk requires specific directory structures, and examples have different project layouts than full applications.

**Decision**: Require app_dir to point directly to the models directory, with full paths for examples.

**Rationale**: This decision acknowledges current Zeitwerk limitations while providing a working solution:
- Enables immediate hot reloading functionality
- Provides clear path configuration examples
- Documents the constraint for future improvement
- Allows examples to work alongside full applications

Noted in documentation that this will be improved in future refactoring to be more flexible.

#### Message-Driven Reload Communication
**Context**: Hot reloading needs to trigger model rebuilding when code changes are detected.

**Decision**: Use the existing Message system with `Message::Reload` events rather than creating a separate callback mechanism.

**Rationale**: This maintains consistency with the framework's event-driven architecture:
- Leverages existing message processing infrastructure
- Keeps reload handling within the normal update cycle
- Provides predictable behavior that follows Elm Architecture patterns
- Allows models to handle reloading as part of their normal message processing

## Impact

The completion of the hot reloading system represents a major milestone for the Milktea framework's developer experience. These changes provide:

**For TUI Application Developers**: Hot reloading dramatically reduces development time by eliminating the need to restart applications when making changes. Developers can now iterate on UI layouts, business logic, and interactions in real-time, seeing results immediately.

**For Framework Architecture**: The Loader independence eliminates a significant architectural debt and provides a clean foundation for future development tooling. The separation of concerns makes the framework more modular and testable.

**For Example Development**: The working hot reloading example serves as both a demonstration and a template for developers setting up their own applications with hot reloading capabilities.

**For Project Documentation**: The comprehensive CLAUDE.md documentation ensures that critical setup knowledge is preserved and accessible to future contributors and users.

The changes demonstrate the framework's maturity in supporting professional development workflows while maintaining the simplicity and elegance of the core TUI architecture.

## Files Modified

- `lib/milktea/loader.rb` - Redesigned to be independent from Config, automatic hot_reload handling
- `lib/milktea/model.rb` - Updated Model#with to use Kernel.const_get for fresh class definitions
- `lib/milktea/config.rb` - Removed loader from Config class to eliminate circular dependencies
- `lib/milktea/program.rb` - Removed loader logic to focus on core TUI functionality
- `examples/hot_reload_demo.rb` - Updated to use new independent Loader pattern
- `examples/hot_reload_demo/models/demo_model.rb` - Added Message::Reload handling with proper rebuilding
- `examples/hot_reload_demo/models/status_model.rb` - Child model demonstrating nested reloading
- `spec/milktea/loader_spec.rb` - Updated tests for new constructor and automatic hot_reload behavior
- `spec/milktea/config_spec.rb` - Removed loader-related tests to match simplified Config
- `CLAUDE.md` - Added comprehensive Hot Reloading Development section with setup and troubleshooting
- `ARCHITECTURE.md` - Updated to reflect new optional Loader system design patterns